# Documentation: Live Call Matchmaking Feature

The **Live Call** feature enables real-time, ephemeral audio pairings between users based on mutual preferences. Unlike the "Swipe" feature, users are not matched in the database initially; the connection is established first, and a formal match is only created if both parties agree to "Connect" after the call.

---

## üõ† Tech Stack
- **Real-time Communication**: Socket.io (Events), Agora RTC (Audio)
- **Backend Logic**: Node.js (In-memory Queue Service)
- **Database**: MongoDB (Formal Match Promotion)
- **Frontend**: Next.js, Framer Motion (Animations), Tailwind CSS

---

## ‚öôÔ∏è Working Logic

### 1. Matchmaking Engine (`LiveCallQueueService`)
- **Queueing**: Users are added to an in-memory `Map` with their profile data (age, gender) and preferences (`lookingFor`, `ageRange`).
- **Filtering**: When a new user joins, the engine iterates through the queue to find a bi-directional match:
  - **Gender**: `User A`'s gender must match `User B`'s `lookingFor`, and vice-versa.
  - **Age**: `User A`'s age must be $\le$ `User B`'s `ageRange`, and vice-versa.
- **Efficiency**: Matches are removed from the queue immediately upon pairing to prevent double-matching.

### 2. Connection Flow
1. **Queueing**: User clicks "Start Call" $\rightarrow$ `live-call-join` (Socket) $\rightarrow$ UI shows "Finding your match...".
2. **Pairing**: Match found $\rightarrow$ Backend generates an **ephemeral Match ID** (`live_uuid`) and an Agora **Channel Name**.
3. **Signaling**: Both users receive `live-match-found`. The frontend transitions to `in-call` status.
4. **The Call**: A 90-second (Stage 1) audio call begins via Agora. 
5. **Decision**: When the timer hits 0, the `StagePromptModal` appears.
6. **Promotion**: If **both** users click "Let's Go!", the client emits `live-call-promote-match`. The backend then creates a permanent `Match` record in MongoDB with `stage: 'unlocked'`.

### 3. State Management (`useLiveCall`)
- Uses a state machine: `idle` $\rightarrow$ `queueing` $\rightarrow$ `connecting` $\rightarrow$ `in-call` $\rightarrow$ `error`.
- Cleans up (leaves queue) automatically on component unmount or socket disconnection.

---

## üöÄ Future Implementations & Improvements

### 1. Scalability (Critical for Growth)
- **üî¥ Problem**: Current queue is in-memory on a single Node.js process.
- **‚úÖ Solution**: Move the `WaitingQueue` to **Redis**. This allows the matchmaking to work across multiple backend instances (load balancers) and prevents queue loss during server restarts.

### 2. Advanced Filtering
- **Distance**: Integrate geolocation to filter matches within a specific radius (e.g., 50km).
- **Interests**: Weight the matching algorithm to pair users with similar `INTERESTS[]` tags.
- **Karma/Rating**: Implement a post-call rating system to prioritize users with high "Good Vibes" scores.

### 3. User Experience (UX)
- **AI Icebreakers**: During the 90s call, display "Icebreaker Questions" on screen generated by the AI Wingman based on mutual interests.
- **Visual Feedback**: Add real-time audio wave visualization to show that the partner is speaking.
- **Blur-to-Clear Video**: Implement a "Stage 2" live call where video starts heavily blurred and gradually clears as the 90s timer progresses.

### 4. Monetization (VIP Features)
- **Priority Queue**: Premium users jump to the front of the `LiveCallQueue`.
- **Global Roaming**: Allow users to change their location to match with people in different cities/countries.
- **Extended Time**: Allow users to use "Flint Coins" to add an extra 60 seconds to a call before the final decision.

### 5. Safety & Moderation
- **Report Button**: Immediate "Report & Block" button inside the `LiveCallOverlay`.
- **Audio Analysis**: Use machine learning (optional) to detect and flag abusive language or harassment in real-time.

---

## üìÇ File Reference
- **Backend Service**: `backend/src/features/realtime/services/live-call-queue.service.ts`
- **Socket Handler**: `backend/src/features/realtime/handlers/live-call.handler.ts`
- **Frontend Hook**: `frontend/src/features/home/hooks/useLiveCall.ts`
- **UI Components**: `frontend/src/features/home/components/LiveCallOverlay.tsx`
